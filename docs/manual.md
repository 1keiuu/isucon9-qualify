ISUCON9 予選マニュアル
===

[ISUCON9 予選レギュレーション](./regulation.md)も併せてご確認ください。

# はじめに

## スケジュール

- 10:00 競技開始
- 18:00 競技終了
- 以後主催者により結果チェックと追試

## ISUCON9 予選 ポータルサイト

予選進行は以下のポータルからベンチマーク走行のリクエスト・結果チェックを行って進行します。事前に登録した情報を用いてログインしてください。

**このページは18:00を過ぎると即座に閲覧不可能になります。ご注意ください。**

TODO: Portal URL

ポータルサイトでは、ベンチマーカーが負荷をかける対象となるサーバーを1台に加え、競技に利用するサーバーを2台入力することができます。 後述する競技後の追試でもこの設定を利用します。

**追試が実行できない場合は失格になるので、競技終了までにこの情報が正しいことを必ず確認してください。**

ポータルサイトでは、ベンチマーク走行の処理状況も確認できます。 ベンチマーク走行が待機中もしくは実行中の間はリクエストは追加できません。

## サーバー、ネットワーク構成について

Alibaba Cloud上のサーバーインスタンス(ECS)を指定したOSイメージから起動し、利用します。インスタンスは最大3台まで起動することができます。

[重要] 競技終了後は、追試を行いますので、運営からお知らせをするまで、インスタンスは終了しないでください。
[重要] 競技に利用する以外のインスタンスを起動していた場合は、競技終了までに停止するかリリースしてください。3台以上のインスタンスが起動している場合、失格となります。やむを得ず、停止できないインスタンスがある場合は速やかに運営まで連絡してください // TODO これレギュレーションに

運営から、追試の終了と順位の確定のお知らせが出たあとは、インスタンスを停止・リリースできます。料金が発生することもありますので、忘れずに対応お願いします。

# 作業開始

以下の順序で作業を開始してください。

## 1. 予選用イメージファイルを利用したインスタンスの起動

インスタンスのスペックは以下を指定してサーバーを起動してください。

- 「エキスパート向け（Custom Launch）」
- 価格モデル「従量課金（Pay-As-You-Go）」
- リージョン「日本（東京）」、「アジア東北 1 ゾーンA」
- インスタンスタイプ ecs.sn1ne.large と指定
- 共有イメージ「共有イメージ」を指定、　「ポータル上で指定されるイメージ名」を指定
- システムディスク「Ultra クラウドディスク」「40GiB」

- ネットワークはVPC「デフォルトVPC」「デフォルトSwitch」を選択
 - 「イメージファイル展開の確認」を行なっている際は、その際に自動で作られたデフォルトVPC・Switchを使います
- ネットワーク課金タイプで「トラフィック課金」で「100M」を入力
- セキュリティグループは、HTTPポート80,HTTPSポート 443,ポート22を選択
 - 「イメージファイル展開の確認」を行なっている際は、その際に自動で作られたセキュリティグループを使います

- ログイン認証は「キーペアの作成」を押してキーペアを作り、もどってから「更新」を押して選択する
 - 「イメージファイル展開の確認」を行なっている際は、その際に作成したキーペアも使えます
- インスタンス名・ホストは自由に設定してください
- RAMロールから「ISUCON9」を選択
 - 「イメージファイル展開の確認」の際に作成しています。作成していない場合は以下のblogを参考にしてください

事前にイメージの展開の確認をした際のインスタンススペックと同一になります。以下のblogも参考に予選用のイメージを指定して起動してください
http://isucon.net/archives/53665373.html

[確認] インスタンス起動後 `/usr/local/bin/isucon-instance-checker` を実行し、起動したインスタンスのスペックに誤りがないか確認できます


## 2. サーバーへのログイン

起動したインスタンスのグローバルIPアドレスに対して `ssh` してください。ログインにはインスタンス作成時に指定したキーペアを使います。sshログインするユーザ名は `root` です。

サーバーには予選終了後の主催者による確認作業(追試)のため、 isucon-admin ユーザーのアカウントがあります。

[重要] isucon-admin ユーザーのアカウントに関して、アカウントの削除や既存の公開鍵の削除を行ったことにより主催者による追試をおこなうことができない場合は、失格とします。

## 3. アプリケーションの動作確認

初期状態ではWebサーバーのグローバルIPアドレスに、ブラウザからアクセスするとアプリが表示されます。

`GET /` へアクセスすることで、トップページにアクセスすることができます。
画面の「新規会員登録」から、ユーザを作成あるいは以下のテスト用ユーザが利用できます

| id       | password |
|----------|----------|
| isudemo1 | isudemo1 |
| isudemo2 | isudemo2 |
| isudemo3 | isudemo3 |

TODO: /etc/hosts に global ipを書くようにする

## 4. 負荷走行

ベンチマーク走行を行う際はポータルサイト上からリクエストします。
リクエストの際には対象となるサーバーの設定が必要です。

ポータルサイト上のServersタブにアクセスして、ベンチマーク走行を実行したいサーバーを追加してください。

その後、追加したサーバーをベンチマークの対象として設定を保存してください。

ポータルサイト上のDashboardタブにアクセスして、Enqueueをクリックすると、ベンチマーク走行リクエストがキューイングされ、主催者が用意したベンチマークサーバーにより順次処理されます。

詳細については後述します。

## 参照実装の切り替え方法

初期状態ではGoによる実装が起動している状態になります。

各言語実装は `systemd` で管理されています。
例えば、参照実装をGoからPerlに切り替えるには次のようにします。

```sh
$ sudo systemctl stop    isucari.go.service
$ sudo systemctl disable isucari.go.service
$ sudo systemctl start   isucari.perl.service
$ sudo systemctl enable  isucari.perl.service
```

ただし、PHPを使う場合のみ、 `systemd` の設定変更の他に、次のように nginx の設定ファイルの変更が必要です。

```sh
$ sudo unlink /etc/nginx/sites-enabled/isucari.conf
$ sudo ln -s /etc/nginx/sites-available/isucari.php.conf /etc/nginx/sites-enabled/isucari.conf
$ sudo systemctl restart nginx.service
```


## リカバリ方法

DB(isucari)を初期状態にもどすには、次のコマンドを実行します。

```sh
$ /home/isucon/isucari/webapp/sql/init.sh
```

# ISUCARIについて

## ストーリー

ISUCARIは椅子を売りたい人/買いたい人をつなげるフリマアプリです。

- 日々開発が進められ、新機能も次々リリースされています。
- 先日もBump機能がリリースされたばかり
- 世界的な椅子ブームを追い風に順調に成長を続け
- さらなる成長を見込み社長は「ｲｽｺｲﾝ還元キャンペーン」を企画
- しかし、「ｲｽｺｲﾝ還元キャンペーン」の驚異的な拡散力により負荷に耐えられないことが発覚
- 社長「緊急メンテナンスをいれていいので18時までに改修しろ。18時にプロモーション開始だ」

# ルール詳細

指定された競技用サーバー上のアプリケーションのチューニングを行い、それに対するベンチマーク走行のスコアで競技を行います。
与えられた競技用サーバーのみでアプリケーションの動作が可能であれば、どのような変更を加えても構いません。
ベンチマーカーとブラウザの挙動に差異がある場合、ベンチマーカーの挙動を正とします。
また、初期実装は言語毎に若干の挙動の違いはありますが、ベンチマーカーに影響のない挙動に関しては仕様とします。

## 商品取得APIと更新の反映について

ISUCARIには以下の商品取得APIがあります。

- 新着一覧
- カテゴリ毎新着一覧
- ユーザ毎一覧
- 取引一覧
- 商品詳細

商品が出品・編集された場合は、カテゴリ、ユーザ、取引、商品詳細APIに即座に反映してください。
購入された商品については、全ての商品取得APIで即座に情報を更新してください。
古いデータの削除、非表示はベンチマークの許可されません。各商品一覧取得APIが返す商品数は初期実装と同じ状態を保つ必要があります。
以上の条件に反しない範囲で、新しい機能を作る事もできます。

## ベンチマーク走行

ベンチマーク走行は以下のように実施されます。

1. 初期化処理の実行 `GET /initialize` (20秒以内)
2. アプリケーション互換性チェックの走行 (適宜: 数秒〜数十秒)
3. 負荷走行 (60秒)
4. 負荷走行後の確認 (適宜: 数秒〜数十秒)

各ステップで失敗が見付かった場合にはその時点で停止します。
ただし、負荷走行中のエラーについては、タイムアウトや500エラーを含む幾つかのエラーについては無視され、ベンチマーク走行が継続します。

## スコア計算

スコアは売り上げた商品(椅子)の価格の合計(以下、総取引額)をベースに計算されます。

以下の条件のエラーは、ベンチマークの失敗、減点の対象となります。(TODO: 回数や減点されるスコアについて詳しく書く？)

- 一定時間内にレスポンスが返却されない・タイムアウト
- HTTPステータスコードが想定と一致しない
- コンテンツの内容チェックを通過する

HTTPステータスコードは、基本的に参照実装と同一のものを想定しています。
[TODO: 静的コンテンツにリクエストしない旨の言及はするか？]ただし、静的コンテンツに関しては、HTTPの規則の範囲内でステータスコード200の代わりに304を返すことができます。


## 制約事項

以下の事項に抵触すると失格(fail)となり、点数が0点になります。

- `GET /initialize` へのレスポンスが20秒以内に戻らない場合
- アプリケーション互換性チェックに失敗した場合
- 負荷走行後の確認へのレスポンスが下記の規定秒数以内に戻らない場合
    * `GET /reports.json`: 5秒以内
- その他、ベンチマーカーのチェッカが失敗を検出したケース

最初に呼ばれる初期化処理 `GET /initialize` は用意された環境内で、チェッカツールが要求する範囲の整合性を担保します。
サーバーサイドで処理の変更・データ構造の変更などを行う場合、この処理が行っている内容を漏れなく提供してください。
また、この処理が20秒以上レスポンスを返さない場合、失格とします。

アプリケーションは全て、保存データを永続化する必要があります。
つまり処理実施後に再起動が行われた場合、再起動前に行われた処理内容が再起動後に保存されている必要があります。
また、アプリケーションは、ブラウザ上での表示を初期状態と同様に保つ必要があります。
予選終了後に行われる主催者による確認作業(追試)においてこれらの点が確認されます。


# リーダーボードの更新について

[TODO: 今年も一緒？]ポータルサイト上のリーダーボードのスコアは、競技終了前の1時間は表示は更新されなくなり、自チームのスコアのみ確認が可能になります。


## 予選終了後の作業について

予選終了後は、サーバーに対して一切の操作を行わないでください。
運営が追試に利用します。
予選参加日終了後、主催者からベンチマーク走行成績の追試、ならびにデータ永続化、画面表示に関するチェックが行われます。
作業完了は当日夜、もしくは翌日夜を予定しています。
http://isucon.net/ における予選の結果発表をもって、この保存期間を終了するものとします。


# 予選通過

予選は以下のルールで通過者が決定します。

各チームの終了時スコアに基づき予選通過者を決定します。
最後に提出したスコアがfailしていたチームは失格となります。

1. 予選各日の終了時スコアにおける上位3チーム
2. 予選両日を通し、1の該当チームを除いた中での上位24チーム

[TODO: 学生枠不設置に関して言及はするか]

# その他

サポートは事前に連絡のあったDiscord のチャンネルにて行いますが、基本的に、予選環境の構成・操作方法やベンチマーカーの処理内容については返答しません。
また、以下のURLにこれまで返答された質問などがまとめられています。
何かある時には一度ご覧ください。

[ISUCON9faq.md](https://gist.github.com/) [TODO: リンク貼る]
