ISUCON9 予選マニュアル
===

[ISUCON9 予選レギュレーション](./regulation.md)も併せてご確認ください。

# はじめに

## スケジュール

- 10:00 競技開始
- 18:00 競技終了
- 以後主催者により結果チェックと追試

## ISUCON9 予選 ポータルサイト

予選進行は以下のポータルからベンチマーク走行のリクエスト・結果チェックを行って進行します。事前に登録した情報を用いてログインしてください。

**このページは18:00を過ぎると即座に閲覧不可能になります。ご注意ください。**

TODO: Portal URL

ポータルサイトでは、ベンチマーカーが負荷をかける対象となるサーバーを1台選択することができます。 後述する競技後の追試でもこの設定を利用します。

**追試が実行できない場合は失格になるので、競技終了までにこの情報が正しいことを必ず確認してください。**

ポータルサイトでは、ベンチマーク走行の処理状況も確認できます。 ベンチマーク走行が待機中もしくは実行中の間はリクエストは追加できません。

## サーバー、ネットワーク構成について

TODO

# 作業開始

以下の順序で作業を開始してください。

## 1. イメージファイルの展開

TODO

## 2. アプリケーションの動作確認

初期状態ではWebサーバーのグローバルIPアドレスに、ブラウザからアクセスするとアプリが表示されます。

`GET /` へアクセスすることで、トップページにアクセスすることができます。
画面の「新規会員登録」から、ユーザを作成することができます。

## 3. 負荷走行

ベンチマーク走行を行う際はポータルサイト上からリクエストします。
リクエストの際には対象となるサーバーの設定が必要です。

ポータルサイト上のServersタブにアクセスして、ベンチマーク走行を実行したいサーバーを追加してください。

その後、追加したサーバーをベンチマークの対象として設定を保存してください。

ポータルサイト上のDashboardタブにアクセスして、Enqueueをクリックすると、ベンチマーク走行リクエストがキューイングされ、主催者が用意したベンチマークサーバにより順次処理されます。
詳細については後述します。

## 参照実装の切り替え方法

初期状態ではGoによる実装が起動している状態になります。

各言語実装は `systemd` で管理されています。
例えば、参照実装をGoからPerlに切り替えるには次のようにします。

```sh
$ sudo systemctl stop    isucari.go.service
$ sudo systemctl disable isucari.go.service
$ sudo systemctl start   isucari.perl.service
$ sudo systemctl enable  isucari.perl.service
```

ただし、PHPを使う場合のみ、 `systemd` の設定変更の他に、次のように nginx の設定ファイルの変更が必要です。

```sh
$ sudo unlink /etc/nginx/sites-enabled/isucari.conf
$ sudo ln -s /etc/nginx/sites-available/isucari.php.conf /etc/nginx/sites-enabled/isucari.conf
$ sudo systemctl restart nginx.service
```


## リカバリ方法

TODO
`~isucon/torb/db` ディレクトリに、スキーマを定義した `schema.sql` ファイルと、初期データセットが入った `isucon8q-initial-dataset.sql.gz` ファイルがあります。

DBを初期状態にもどすには、DBサーバーにログインして、次のコマンドを実行します。

```sh
$ ~isucon/torb/db/init.sh
```

`~isucon/torb/db` ディレクトリと `~isucon/torb/webapp` ディレクトリは競技用の全サーバーに存在するので、間違って重要なファイルを消してしまっても他のサーバーからリカバリすることができます。


# ルール詳細

指定された競技用サーバー上のアプリケーションのチューニングを行い、それに対するベンチマーク走行のスコアで競技を行います。
与えられた競技用サーバーのみでアプリケーションの動作が可能であれば、どのような変更を加えても構いません。
ベンチマーカーとブラウザの挙動に差異がある場合、ベンチマーカーの挙動を正とします。
また、初期実装は言語毎に若干の挙動の違いはありますが、ベンチマーカーに影響のない挙動に関しては仕様とします。


## ベンチマーク走行

ベンチマーク走行は以下のように実施されます。

1. 初期化処理の実行 `GET /initialize` ([TODO: 10秒]以内)
2. アプリケーション互換性チェックの走行 (適宜: 数秒〜数十秒)
3. 負荷走行 (60秒 - 2.の互換性チェックにかかった時間)
4. 負荷走行後の確認 (適宜: 数秒〜数十秒)

各ステップで失敗が見付かった場合にはその時点で停止します。
ただし、負荷走行中のエラーについては、タイムアウトや500エラーを含む幾つかのエラーについては無視され、ベンチマーク走行が継続します。

負荷走行中は、毎秒負荷レベルが増えていきます。
ただし、過去5秒以内に何らかのエラーが発生していた場合は負荷レベルが上昇しません。
終了時の負荷レベルや、負荷レベルが上がらない原因になったエラーについてはポータルサイトから確認することができます。

## スコア計算

スコアは売り上げた椅子の合計金額をベースに計算されます。

以下を満たした場合リクエストが成功したと判定します。

- タイムアウトせずにレスポンスを返却する
- HTTPステータスコードが想定と一致する
- コンテンツの内容チェックを通過する

HTTPステータスコードは、基本的に参照実装と同一のものを想定しています。
[TODO: 静的コンテンツにリクエストしない旨の言及はするか？]ただし、静的コンテンツに関しては、HTTPの規則の範囲内でステータスコード200の代わりに304を返すことができます。

[TODO: この行はなしでよさげ？]なお、問題ページの内容はできるだけ最新の状態を反映させる必要がありますが、1秒以内の遅延は許されます。


## 制約事項

以下の事項に抵触すると失格(fail)となり、点数が0点になります。

- `GET /initialize` へのレスポンスが[TODO: 10秒]以内に戻らない場合
- アプリケーション互換性チェックに失敗した場合
- 負荷走行後の確認へのレスポンスがそれぞれ下記の規定秒数以内に戻らない場合
    * `POST /admin/api/actions/login`: 20秒以内
    * `GET /admin/api/reports/sales`: 60秒以内
- その他、ベンチマーカーのチェッカが失敗を検出したケース

最初に呼ばれる初期化処理 `GET /initialize` は用意された環境内で、チェッカツールが要求する範囲の整合性を担保します。
サーバーサイドで処理の変更・データ構造の変更などを行う場合、この処理が行っている内容を漏れなく提供してください。
また、この処理が[TODO: 10秒]以上レスポンスを返さない場合、失格とします。

アプリケーションは全て、保存データを永続化する必要があります。
つまり処理実施後に再起動が行われた場合、再起動前に行われた処理内容が再起動後に保存されている必要があります。
また、アプリケーションは、ブラウザ上での表示を初期状態と同様に保つ必要があります。
予選終了後に行われる主催者による確認作業(追試)においてこれらの点が確認されます。


# リーダーボードの更新について

[TODO: 今年も一緒？]ポータルサイト上のリーダーボードのスコアは、競技終了前の1時間は表示は更新されなくなり、自チームのスコアのみ確認が可能になります。


## 予選終了後の作業について

予選終了後は、サーバーに対して一切の操作を行わないでください。
運営が追試に利用します。
予選参加日終了後、主催者からベンチマーク走行成績の追試、ならびにデータ永続化、画面表示に関するチェックが行われます。
作業完了は当日夜、もしくは翌日夜を予定しています。
http://isucon.net/ における予選の結果発表をもって、この保存期間を終了するものとします。


# 予選通過

予選は以下のルールで通過者が決定します。

各チームの終了時スコアに基づき予選通過者を決定します。
最後に提出したスコアがfailしていたチームは失格となります。

1. 予選各日の終了時スコアにおける上位3チーム
2. 予選両日を通し、1の該当チームを除いた中での上位24チーム

[TODO: 学生枠不設置に関して言及はするか]

# その他

サポートは事前に連絡のあったDiscord のチャンネルにて行いますが、基本的に、予選環境の構成・操作方法やベンチマーカーの処理内容については返答しません。
また、以下のURLにこれまで返答された質問などがまとめられています。
何かある時には一度ご覧ください。

[ISUCON9faq.md](https://gist.github.com/) [TODO: リンク貼る]

